#!/usr/bin/env node
var package = require("../package")
var _ = require("underscore")
var Umd = require("../")

var USAGE = "Usage: " + package.name + " [OPTIONS] COMMAND"
var OPTIONS = [
  "Options:",
  "  -h, -?, --help  Display this help and exit."
].join("\n")
var COMMANDS = [
  "Commands:",
  "  iife FILE  Wrap in an immediately-invoked function expression.",
  "  iffy FILE  Alias of iife.",
  "  help       Display this help and exit."
].join("\n")

function help() {
  info(USAGE)
  info()
  info(OPTIONS)
  info()
  info(COMMANDS)
}

function info(string) { process.stdout.write((string || "") + "\n") }
function warn(string) { process.stderr.write((string || "") + "\n") }

var opts = (function() {
  var long = {
    "help": Boolean
  }
  var short = {
    "h": "help",
    "?": "help"
  }

  var opts = require("nopt")(long, short)
  var unrecognized = _.difference(Object.keys(opts), Object.keys(long), "argv")

  if (unrecognized.length) {
    warn("Unrecognized option: " + unrecognized[0])
    warn(USAGE)
    process.exit(1)
  }

  opts.command = opts.argv.remain.shift()
  opts.argv = opts.argv.remain

  return opts
})()

switch (true) {
  case opts.help:
  case !opts.command:
  case opts.command == "help":
    help()
    process.exit()
    break

  case opts.command == "iife":
  case opts.command == "iffy":
    if (opts.argv.length != 1) {
      warn(package.name + ": Please give a file to `iife'.")
      process.exit(1)
    }

    umdify(Umd.Iife, opts.argv[0])
    break

  default:
    warn("Unrecognized command: " + opts.command)
    warn(USAGE)
    process.exit(1)
}

function umdify(klass, file) {
  try {
    var output = new klass().wrap(file)
    process.stdout.write(output)
  }
  catch (ex) {
    warn(package.name + ": " + ex)
    process.exit(1)
  }
}
